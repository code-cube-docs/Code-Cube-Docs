
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../tag-inactivity/">
      
      
        <link rel="next" href="../consent-monitoring/">
      
      
      <link rel="icon" href="../../logo.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.17">
    
    
      
        <title>Offload to own BigQuery environment - Code Cube documentation library</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.bcfcd587.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-K6VCS5W');</script>
  <!-- End Google Tag Manager -->


    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#manage-access-to-raw-tag-monitoring-data-in-bigquery" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Code Cube documentation library" class="md-header__button md-logo" aria-label="Code Cube documentation library" data-md-component="logo">
      
  <img src="../../code cube logo white.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Code Cube documentation library
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Offload to own BigQuery environment
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../error-monitoring-client-side/" class="md-tabs__link">
          
  
  Tag Monitor

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../datalayer-guard/events-tag-manager/" class="md-tabs__link">
          
  
  DataLayer Guard

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Code Cube documentation library" class="md-nav__button md-logo" aria-label="Code Cube documentation library" data-md-component="logo">
      
  <img src="../../code cube logo white.png" alt="logo">

    </a>
    Code Cube documentation library
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Tag Monitor
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Tag Monitor
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../error-monitoring-client-side/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ⚒️ Configuration client-side
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../error-monitoring-server-side/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ⚒️ Configuration server-side
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tag-bulk-edit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bulk editing your tags in GTM
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tag-inactivity/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Enabling Tag Inactivity
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Offload to own BigQuery environment
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Offload to own BigQuery environment
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#managing-access-to-the-data" class="md-nav__link">
    <span class="md-ellipsis">
      Managing access to the data
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../consent-monitoring/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Consent Monitoring
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../serverside-error-logging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Server-side error logging
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    DataLayer Guard
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            DataLayer Guard
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../datalayer-guard/events-tag-manager/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Monitoring events via Tag Management
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#managing-access-to-the-data" class="md-nav__link">
    <span class="md-ellipsis">
      Managing access to the data
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="manage-access-to-raw-tag-monitoring-data-in-bigquery">Manage access to raw Tag Monitoring data in BigQuery</h1>
<p>To offload BigQuery data from one project to another, we'll create a scheduled query managed by a service account.</p>
<h2 id="managing-access-to-the-data">Managing access to the data</h2>
<details>
<summary>Create a service account </summary>

1. In the Google Cloud console, go to the Create [service account page](https://console.cloud.google.com/projectselector2/iam-admin/serviceaccounts/create?walkthrough_id=iam--create-service-account&_ga=2.256991880.228167773.1709798988-298617199.1684135176#step_index=1).

2. Select your Google Cloud Project.

3. Enter a name for the service account.
_The Google Cloud console generates a service account ID based on this name. Edit the ID if necessary. You cannot change the ID later_.

4. Assign the **BigQuery User** IAM role.

5. Click Done to finish creating the service account.
</details>

<details>
<summary>Managing access rights</summary>

Share the service account ID with your contact at Code Cube to confirm proper access rights management.
</details>

<details>
<summary>Create the BigQuery dataset</summary>

1. Open the BigQuery page in the Google Cloud console.
2. In the Explorer panel, select the project where you want to create the dataset.
3. Expand the Actions option and select 'Create dataset'.
4. Enter a unique dataset name (e.g., 'codecube-tagmonitor').
5. Select **multi-region** and **EU** for the location type.
6. Click **Create dataset**.
</details>
<details>
<summary>Create the BigQuery table for client-side monitoring</summary>

1. Select the new dataset and click **'Create table'**
2. Choose 'Empty table' as the table type.
3. Select your GCP project and newly created dataset, gave it an descriptive name like 'raw_data_client'.
4. Define the table schema as follows:    

        | Field name        | Type      | Mode |
        | :---------------- | --------- | --------
        | timestamp         | Title     |
        | initial_url       | STRING    | NULLABLE
        | url               | STRING    | NULLABLE
        | event_name        | STRING    | NULLABLE
        | event_timestamp   | STRING    | NULLABLE
        | container_version | STRING    | NULLABLE
        | container_id      | STRING    | NULLABLE
        | tag               | RECORD    | REPEATED
        | id                | STRING    | NULLABLE
        | name              | STRING    | NULLABLE
        | status            | STRING    | NULLABLE
        | channel           | STRING    | NULLABLE
        | execution_time    | STRING    | NULLABLE
        | parameters        | STRING    | REPEATED
        | key               | STRING    | NULLABLE
        | value               | STRING    | NULLABLE

4. Partitioning: Select 'No partitioning'
5. Click on **Create table**
</details>

<details>
<summary>Create the table for server-side monitoring</summary>

1. Select the new dataset and click **'Create table'**
2. Choose 'Empty table' as the table type.
3. Select your GCP project and newly created dataset, gave it an descriptive name like 'raw_data_server'.
4. Define the table schema as follows:    


        | Field name        | Type      | Mode |
        | :---------------- | --------- | --------
        | timestamp         | Title     |
        | url               | STRING    | NULLABLE
        | event_name        | STRING    | NULLABLE
        | event_timestamp   | STRING    | NULLABLE
        | client_name       | STRING    | NULLABLE
        | container_version | STRING    | NULLABLE
        | container_id      | STRING    | NULLABLE
        | env_name          | STRING    | NULLABLE
        | tag               | RECORD    | REPEATED
        | id                | STRING    | NULLABLE
        | name              | STRING    | NULLABLE
        | status            | STRING    | NULLABLE
        | execution_time    | STRING    | NULLABLE
        | parameters        | STRING    | REPEATED
        | key               | STRING    | NULLABLE
        | value               | STRING    | NULLABLE

4. Partitioning: Select 'No partitioning'
5. Click on **Create table**
</details>

<details>
<summary>1. Creating Queries</summary>
Write queries to retrieve client-side and server-side data.

#### Client-side data

<pre><code class="language-sql">SELECT * FROM `code-cube.{{dataset_name}}.raw_data_client`
WHERE DATE(timestamp) = DATE(DATE_ADD(CURRENT_TIMESTAMP(), INTERVAL -1 DAY))
</code></pre>


#### Server-side data


<pre><code class="language-sql">SELECT * FROM `code-cube.{{dataset_name}}.raw_data_server`
WHERE DATE(timestamp) = DATE(DATE_ADD(CURRENT_TIMESTAMP(), INTERVAL -1 DAY))
</code></pre>

The {{dataset}} name is equal to the dataset name shown on the Tag Monitor configuration page.
</details>

<details>
<summary>2. Create the scheduled query </summary>
Set up scheduled queries to automate data retrieval.

1. Provide details and schedule for the query (once a day)
2. Add destination details for query results.
4. Add the service account
5. Save the settings
</details>

</details>







  
  




  



                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.top", "navigation.path", "navigation.sections", "navigation.tabs"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
<!-- Google Tag Manager (noscript) -->
  <script>
    var gtm = document.createElement('noscript');
    var iframe = document.createElement('iframe');

    iframe.setAttribute('src', "https://www.googletagmanager.com/ns.html?id=GTM-K6VCS5W");
    iframe.setAttribute('height' , 0);
    iframe.setAttribute('width', 0);
    iframe.style.display = "none";
    iframe.style.visibility = "hidden";
    
    gtm.appendChild(iframe);
    
    
    var s = document.getElementsByTagName('body')[0];
    s.insertBefore(gtm, s.firstElementChild);
    </script>


<!-- End Google Tag Manager (noscript) -->
  
      <script src="../../assets/javascripts/bundle.1e8ae164.min.js"></script>
      
    
  
  </body>
</html>